<html>

<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>
    <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>
    <script type="text/javascript">
/**
 * https://developer.mozilla.org/de/docs/Web/API/ServiceWorkerContainer/register
 */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js', {
                scope: './'
            }).then(function (registration) {
                document.querySelector('#status').textContent = 'succeeded';
            }).catch(function (error) {
                document.querySelector('#status').textContent = error;
            });
        } else {
            // The current browser doesn't support service workers.
            var aElement = document.createElement('a');
            aElement.href = 'http://www.chromium.org/blink/serviceworker/service-worker-faq';
            aElement.textContent = 'unavailable';
            document.querySelector('#status').appendChild(aElement);
        }

        // end copied code

        var conn, peer;

        function addFileToCache(meta, blob) {
            var location = document.location.origin + meta.path + meta.name;
            caches.open('files').then(function (cache) {
                var response = new Response(blob, {
                    "status": 200,
                    "headers": {
                        "content-type": meta.type,
                        "content-length": meta.size
                    },
                    "url": location
                });
                cache.put(location, response);
            });
            return location;
        }

        function receive(data, connection) {
            var messages = $('#messages');
            var date = new Date();
            var time = date.getHours() + ':' + date.getMinutes() + ':' + date.getSeconds();
            messages.append(connection.peer + " (" + time + "):<br>");

            if (data.type === 'text') {
                /* TEXT */
                messages.append("text:", data.data);
            } else if (data.type === 'file') {
                /* FILE */
                messages.append("file");
                // create Blob from ArrayBuffer
                var blob = new Blob([new Uint8Array(data.data)]);
                var path = window.URL.createObjectURL(blob);
                var location = addFileToCache(data.meta, blob);

                if (data.meta.type.startsWith('image')) {
                    // file/image
                    messages.append("/image:");
                    messages.append(`<img src="${path}" width="100%" title="${data.meta.name}">`)
                    messages.append(`<a href="${location}">fetch file</a>`);
                    console.log('image received', data);
                } else {
                    console.log('unsupported data type received', data);
                }
            } else {
                console.log('unsupported data received', data);
            }
            messages.append("<br>");

        }

        function registerPeer() {

            peer = new Peer({
                key: '6penu7xt66dh1tt9',
                debug: 3,
                logFunction: function () {
                    var copy = Array.prototype.slice.call(arguments).join(' ');
                    $('#log').prepend(copy + '<br>');
                }
            });

            peer.on('open', function (id) {
                console.log('My peer ID is: ' + id);
                $('#myPeerId').val(id);
            });

            peer.on('connection', function (conn) {
                conn.on('data', function (data) {
                    console.log('peer received data:', data);
                    receive(data, conn);
                });
            });

        }


        var setupConnection = function (otherPeerId, options) {
            conn = peer.connect(otherPeerId);

            conn.on('open', function () {
                var me = $('#myPeerId').val();
                conn.send(`hi, there is ${me} connected.`);
            });

            conn.on('close', function () {
                console.log('connection closed...')
            });

            conn.on('error', function (err) {
                console.log('an error occured:', err);
            });
        }

        $(document).ready(function () {

            $('#connect').click(function () {
                var otherPeerId = $('#otherPeerId').val();
                if (otherPeerId) {
                    console.log('try connect to', otherPeerId);
                    return setupConnection(otherPeerId, {
                        label: 'filetransfer',
                        reliable: true
                    });
                } else {
                    console.log('no other peer id given');
                    return;
                }
            });

            $('#close').click(function () {
                console.log('close connection...');
                conn.close();
            });

            $('#sendMessage').click(function () {
                var message = $('#message').val();
                console.log('send message:', message);
                var data = {
                    type: "text",
                    data: message
                };
                conn.send(data);
            });

            $('#sendFile').click(function () {
                var fileBlob = $('#file')[0].files[0];
                console.log('send file', fileBlob);
                var data = {
                    type: "file",
                    meta: {
                        name: fileBlob.name,
                        path: "/location/on/host/",
                        type: fileBlob.type,
                        size: fileBlob.size,
                        lastModifiedDate: fileBlob.lastModifiedDate,
                        encoding: "what?"
                    },
                    data: fileBlob // will be converted as arraybuffer
                };
                conn.send(data);
            });

            $('#register').click(function () {
                registerPeer();
            });

            // todo add sample file to cache for later transfer

        });
    </script>
</head>

<body>
    <div>
        Service-Worker Status: <div id="status"></div>
    </div>
    <div>
        My peer id:
        <input id="myPeerId" type="text" placeholder="click register...">
        <input id="register" name="register" type="button" value="register">
    </div>
    <div>
        Connect to peer id:
        <input id="otherPeerId" name="otherPeerId" type="text" placeholder="add other peer id...">
        <input id="connect" name="connect" type="button" value="connect">
        <input id="close" name="close" type="button" value="close">
    </div>
    <div>&nbsp;</div>
    <div>
        Write Message:
        <input id="message" name="message" type="text">
        <input id="sendMessage" name="sendMessage" type="button" value="send message">
    </div>
    <div>
        Send file:
        <input id="file" name="file" type="file">
        <input id="sendFile" name="sendFile" type="button" value="send file">
    </div>
    <table>
        <tr valign="top">
            <td>
                <h3>Log:</h3>
                <div id="log"></div>
            </td>
            <td>
                <h3>Messages:</h3>
                <div id="messages"></div>
            </td>
        </tr>
    </table>
</body>

</html>
