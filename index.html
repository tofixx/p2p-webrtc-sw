<html>
    <head>
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js" type="text/javascript"></script>
        <script src="http://cdn.peerjs.com/0.3/peer.min.js"></script>  
        <script type="text/javascript">
          var conn, peer;

            function registerPeer(){

                peer = new Peer({
                key: '6penu7xt66dh1tt9',
                debug: 3,
                logFunction: function() {
                    var copy = Array.prototype.slice.call(arguments).join(' ');
                    $('.log').append(copy + '<br>');
                }
            }); 

            peer.on('open', function(id) {
                console.log('My peer ID is: ' + id);
                $('#myPeerId').val(id);
            });

            peer.on('connection', function(conn) {
                conn.on('data', function(data){
                    console.log('data received:', data);
                });
            });  

            }


            var setupConnection = function (otherPeerId, options) {
                conn = peer.connect(otherPeerId);
                
                conn.on('open', function(){
                    var me = $('#myPeerId').val();
                    conn.send(`hi, there is ${me}`);

                });  

                conn.on('close', function(){
                    console.log('connection closed...')
                });

                conn.on('error', function(err){
                    console.log('an error occured:', err);
                });
            }
            
          $(document).ready(function(){

            $('#connect').click(function(){
                var otherPeerId = $('#otherPeerId').val();
                if(otherPeerId){
                    console.log('try connect to', otherPeerId);
                    return setupConnection(otherPeerId, {
                        label: 'filetransfer', 
                        reliable: true
                    });
                } else {
                    console.log('no other peer id given');
                    return;
                }
            });

            $('#close').click(function(){
                console.log('close connection...');
                conn.close();
            });

            $('#sendMessage').click(function(){
                var message = $('#message').val();
                console.log('send message:', message);
                conn.send(message);
            });

            $('#register').click(function(){
                registerPeer();
            });

            // todo add sample file to cache for later transfer

          });
        </script>      
    </head>
    <body>
    <div>
        My peer id: 
        <input id="myPeerId" type="text" placeholder="click register...">
        <input id="register" name="register" type="button" value="register">
    </div>
    <div>
      Connect to peer id: 
      <input id="otherPeerId" name="otherPeerId" type="text" placeholder="add other peer id...">
      <input id="connect" name="connect" type="button" value="connect">
      <input id="close" name="close" type="button" value="close">
    </div>
    <div>&nbsp;</div>
    <div>
        Write Message:
        <input id="message" name="message" type="text" >
        <input id="sendMessage" name="sendMessage" type="button" value="send message">
    </div>
    <div>
        Send file:
        <input id="file" name="file" type="file">
        <input id="sendFile" name="sendFile" type="button" value="send file">
    </div>
    <h3>Log:</h3>
    <div class="log"></div>
    </body>
</html>
